# Улучшения безопасности авторизации

## Реализованные улучшения

### 1. ✅ Хеширование паролей с помощью bcrypt
- Пароли теперь хешируются перед сохранением в БД
- Используется bcrypt с 10 раундами соли
- Защита от timing attacks при сравнении паролей

**Файлы:**
- `server/utils/password.ts` - утилиты для работы с паролями
- `server/services/user.service.ts` - обновлен для использования хеширования

### 2. ✅ Валидация паролей
- Минимум 8 символов
- Хотя бы одна буква
- Хотя бы одна цифра

**Файлы:**
- `server/utils/password.ts` - функция `validatePassword()`

### 3. ✅ Валидация email и username
- Email проверяется регулярным выражением
- Username: 3-20 символов, только буквы, цифры и подчеркивания

**Файлы:**
- `server/utils/validation.ts` - функции валидации

### 4. ✅ Улучшенная безопасность JWT
- Проверка наличия JWT_SECRET в production
- Минимальная длина секрета - 32 символа
- Срок жизни токена сокращен до 7 дней (настраивается через JWT_EXPIRATION_TIME)
- Предупреждение при использовании дефолтного секрета в разработке

**Файлы:**
- `server/utils/jwt.ts` - обновлена логика работы с JWT

### 5. ✅ Rate Limiting
- Логин: максимум 5 попыток в минуту с одного IP
- Регистрация: максимум 3 попытки в час с одного IP
- In-memory хранилище (в production рекомендуется Redis)

**Файлы:**
- `server/utils/rate-limit.ts` - утилита для rate limiting
- `server/api/users/login.post.ts` - добавлен rate limiting
- `server/api/users/index.post.ts` - добавлен rate limiting

### 6. ✅ Защита от timing attacks
- Использование `bcrypt.compare()` для безопасного сравнения паролей
- Одинаковое время ответа при неверных учетных данных

## Переменные окружения

### Обязательные для production:
```env
JWT_SECRET=your-very-long-and-secure-secret-key-at-least-32-characters
```

### Опциональные:
```env
JWT_EXPIRATION_TIME=7d  # Срок жизни токена (по умолчанию 7 дней)
NODE_ENV=production      # Для активации строгих проверок
```

## Рекомендации для production

1. **Используйте Redis для rate limiting** вместо in-memory хранилища
2. **Установите сильный JWT_SECRET** (минимум 32 символа, лучше 64+)
3. **Используйте HTTPS** для всех запросов
4. **Добавьте CORS настройки** для ограничения источников запросов
5. **Рассмотрите использование refresh tokens** для более безопасной работы с токенами
6. **Добавьте логирование** подозрительной активности
7. **Используйте helmet.js** для дополнительных заголовков безопасности
8. **Регулярно обновляйте зависимости** для исправления уязвимостей

## Миграция существующих пользователей

⚠️ **ВАЖНО:** Существующие пользователи с паролями в открытом виде не смогут войти после обновления.

Для миграции:
1. Создайте скрипт миграции, который хеширует все существующие пароли
2. Или попросите пользователей сбросить пароли через функцию восстановления

## Тестирование

Все улучшения протестированы и готовы к использованию. Убедитесь, что:
- Установлен `bcrypt` и `@types/bcrypt`
- Установлена переменная окружения `JWT_SECRET` в production
- Все тесты проходят успешно

